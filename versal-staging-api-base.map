#!mako|yaml
#versal staging environment map file
<%
## load the pillar file.
from yaml import load, dump
try:
    from yaml import CLoader as Loader, CDumper as Dumper
except ImportError:
    from yaml import Loader, Dumper
import inspect,os

environment='staging'
basedirectory=os.path.dirname(os.path.abspath(inspect.getfile(inspect.currentframe()))) # script directory

stream = file(basedirectory+'/pillar/'+environment+'/servers.sls', 'r')
pillar = load(stream, Loader=Loader)
%>
## setup api servers
<% 
servergroup = pillar["api"]
servernames = pillar["api_names"]
servernum = 0
%>
% for instance in servergroup["instances"]:
${environment}_${servergroup["size"]}_region-${instance["region"]}:
  % for x in range(instance["number"]):
  - ${servernames[servernum]}-r${instance["region"]}-${pillar["domain"]}:
      master: ${pillar["salt_master"]}
      grains:
        roles:
          - ${servergroup["role"]}
        environment: ${pillar["environment"]}
  <% servernum = servernum + 1 %>
  % endfor
% endfor 