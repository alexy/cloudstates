#!mako|yaml
#versal staging environment map file
<%
## load the pillar file.
from yaml import load, dump
try:
    from yaml import CLoader as Loader, CDumper as Dumper
except ImportError:
    from yaml import Loader, Dumper
import inspect,os

environment='staging'
#stream = file('/Users/mini/Versal/cloudstate/pillar/'+environment+'/servers.sls', 'r')
basedirectory=os.path.dirname(os.path.abspath(inspect.getfile(inspect.currentframe()))) # script directory

stream = file(basedirectory+'/pillar/'+environment+'/servers.sls', 'r')
pillar = load(stream, Loader=Loader)
%>
## setup lb servers
<%
servergroup = pillar["lb"]
servernames = pillar["lb_names"]
serverips = pillar["lb_static_ips"]
servernum = 0
%>
% for instance in servergroup["instances"]:
base_ubuntu_${servergroup["size"]}_${instance["provider"]}_${instance["region"]}:
  % for x in range(instance["number"]):
  - ${servernames[servernum]}-${pillar["domain"]}:
      master: ${pillar["salt_master"]}
      grains:
        roles:
          - ${servergroup["role"]}
        environment: ${pillar["environment"]}
    % if servergroup["dns"] == 'static':
        static: ${serverips[servernum]}
    % endif
  <% servernum = servernum + 1 %>
  % endfor
% endfor 